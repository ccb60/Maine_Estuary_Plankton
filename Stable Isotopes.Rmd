---
title: "Stable Isotope Data"
output:
  github_document:
    toc: true
    fig_width: 5
    fig_height: 4
---
<img
    src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
    style="position:absolute;top:10px;right:50px;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center',
                      fig.width = 5, fig.height = 4,
                      collapse = TRUE, comment = "#>")
```

#Introduction
In this notebook I am looking at the stable isotope data and doing some very 
lightweight modeling, looking principally at seasonal patterns. 

#Load Libraries
```{r}
library(tidyverse)
library(readxl)

library(emmeans)

theme_set(theme_minimal())
```

# C N Data and Stable Isotope Data
This is found in two different Tabs.  It appears these are some replicate 
analyses here, labeled in confusing ways....

The Elemental N and C values are labeled as "not blank corrected".  I 
am not sure whether they should be blank corrected, and if so, how to do so 
correctly.  My tendency would be to "correct" by the mean value of the blanks. 
This would have a small effect on elemental carbon, but a sizable effect on 
elemental nitrogen.  

But because of these uncertainties, I focus only on the stable isotope values.


`Sample_ID` codes do NOT match the `Sample_ID` codes from other tabs.  The 
difference is small, but would interfere with matches.  We correct them here.

```{r}
POC1_data <- read_excel("SEANET_Phyto Data_Bigelow.xlsx", 
                        sheet = "POC1", skip = 11, n_max = 30) %>%
  rename(Sample_ID = `Sample ID`) %>%
  mutate(Replicate = substr(Sample_ID, nchar(Sample_ID), nchar(Sample_ID)),
         Sample_ID = substr(Sample_ID, 1, nchar(Sample_ID)-2)) %>%
  relocate(Replicate, .after = 'Sample_ID') %>%
  select(c(1,2,9,10, 11))
  
names(POC1_data)[3] <- 'Delta_N'
names(POC1_data)[4] <- 'Delta_C'
```

```{r}
POC2_data <- read_excel("SEANET_Phyto Data_Bigelow.xlsx", 
                        sheet = "POC2", skip = 11, n_max = 30) %>%
  rename(Sample_ID = `Sample ID`) %>%
  mutate(Replicate = 'C') %>%
  relocate(Replicate, .after = 'Sample_ID') %>%
  select(c(1,2,10, 11, 12))

POC2_data$Replicate[19] <- 'D'  # Only apparent duplicate in second round of analysis

names(POC2_data)[3] <- 'Delta_N'
names(POC2_data)[4] <- 'Delta_C'
```

```{r}
POC_data <- POC1_data %>%
  bind_rows(POC2_data) %>%
  mutate(date = as.Date(substr(Sample_ID, 1,10)),
         site = substr(Sample_ID, 12, nchar(Sample_ID))) %>%
  mutate(Sample_ID = paste0('SNT_', Sample_ID)) %>%
  relocate(date, site, .after = Sample_ID)

```

```{r}
rm(POC1_data, POC2_data)
```

# Data Prevalence
```{r}
xtabs(~ date + site, data = POC_data)
```

Note that I have no geographic data on the Mooring site, and "Mooring" is not 
a site designation in other tabs.  Judging by its sampling history

## Review of Delta_N data
```{r fig.width = 8, fig.height = 4}
ggplot(POC_data, aes(Sample_ID, Delta_N)) +
  geom_point(aes(color = ! is.na(Comments), shape = Replicate)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

We see  two outliers, both of which were flagged in the analytic results as 
"unusually high."  While there is no other indication of WHY they are so high,
I will omit them from further analysis. Note that I chose to drop only the 
Delta_N values, not the related Delta_C values.  I do not know enough about lab
procedures to be sure that is correct.

```{r}
POC_data <- POC_data %>%
  mutate(Delta_N = if_else(row_number() %in% c(16,17), NA_real_, Delta_N))
```

# Calculate Average Values
```{r}
POC_data_sum <- POC_data %>%
  group_by(Sample_ID) %>%
  summarize(Delta_N_mean = mean(Delta_N, na.rm = TRUE),
            Delta_N_SD =   sd(Delta_N, na.rm = TRUE),
            Deta_N_n  =    sum(! is.na(Delta_N)),
            Delta_C_mean = mean(Delta_C, na.rm = TRUE),
            Delta_C_SD =   sd(Delta_C, na.rm = TRUE),
            Deta_C_n  =    sum(! is.na(Delta_C)))
```

We have only a single measurement of most samples, yet the standard errors are 
fairly large for those samples where we **do** have replicates. Careful analysis
would estimate standard errors even for those samples with only a single 
analysis based on the error in the samples for which we have multiple laboratory
results.

## Graphic Exploration of Site and Date
### Delta N Data
```{r}
POC_data_test <- POC_data %>%
  select(-Comments) %>%
  mutate(site = factor(site),
         date_factor = factor(date))
```

```{r}
ggplot(POC_data_test, aes(date, Delta_N)) +
  geom_line(aes(color = site)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

### Delta C Data
```{r}
ggplot(POC_data_test, aes(date, Delta_C)) +
  geom_line(aes(color = site)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

So, looking at Carbon, it looks like late summer samples tend to be high Delta C.

## Quick Models
### Delta N Model
```{r}
delta_N_lm <- lm(Delta_N ~ site * date_factor,  data = POC_data_test)
anova(delta_N_lm)
```

```{r}
emmip(delta_N_lm, site ~ date_factor)
```

So, what jumps out is the UNE site, in the spring, is doing something very
different. The UNE site is on the Saco, so likely dominated by freshwater runoff
in the spring.  I tend to believe just about everything else is just noise, but
it is hard to tell from this plot alone.

### Delta_C Model
```{r}
delta_C_lm <- lm(Delta_C ~ site * date_factor,  data = POC_data_test)
anova(delta_C_lm)
```

```{r}
emmip(delta_C_lm, site ~ date_factor)
```

So here we see a stronger seasonal pattern at all sites, again with UNE doing
something slightly different, and possibly the Mooring also doing something.
